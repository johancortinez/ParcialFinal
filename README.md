/*
  * PARCIAL FNAL Administración Administración de Base de Datos Avanzada 2018-2 Mañana
  * Johan Stiven Diaz Cortinez
  
*/

/*Funcion 1*/
CREATE OR REPLACE FUNCTION CALCULAR_CAJAS_NECESARIAS(ITEMS IN INTEGER, BIG_BOX IN INTEGER, LITLE_BOX IN INTEGER)
RETURN INTEGER AS
  NUM_BIG_BOX INTEGER := 0;
  NUM_LITLE_BOX INTEGER := 0;
  RESULTADO INTEGER := 0;
BEGIN
  NUM_BIG_BOX := FLOOR(ITEMS / 5) ;
  IF (NUM_BIG_BOX > BIG_BOX) THEN
    NUM_BIG_BOX := BIG_BOX;
  END IF;
  NUM_LITLE_BOX := ITEMS - (NUM_BIG_BOX * 5);
  IF (NUM_LITLE_BOX > LITLE_BOX) THEN 
    RESULTADO := -1;
  ELSE 
    RESULTADO := NUM_BIG_BOX + NUM_LITLE_BOX;
  END IF;
  RETURN RESULTADO;
END;

/*Procedimiento almacenado 1*/
CREATE OR REPLACE PROCEDURE PROCESAR_PEDIDOS AS
  ITEMS_PEDIDOS INTEGER := 0;
  CAJAS_GRANDES_PEDIDOS INTEGER := 0;
  CAJAS_PEQUENAS_PEDIDOS INTEGER := 0;
  CANTIDAD_CAJAS_PEDIDOS INTEGER := 0;
CURSOR CURSOR_PEDIDOS IS
  SELECT ITEMS, CAJAS_GRANDES, CAJAS_PEQUENAS
  FROM PEDIDOS;
BEGIN
  OPEN CURSOR_PEDIDOS;
    LOOP
      FETCH CURSOR_PEDIDOS INTO ITEMS_PEDIDOS, CAJAS_GRANDES_PEDIDOS, CAJAS_PEQUENAS_PEDIDOS;
      EXIT WHEN CURSOR_PEDIDOS%NOTFOUND;
      CANTIDAD_CAJAS_PEDIDOS := CALCULAR_CAJAS_NECESARIAS(ITEMS_PEDIDOS, CAJAS_GRANDES_PEDIDOS, CAJAS_PEQUENAS_PEDIDOS);
      UPDATE PEDIDOS SET CANTIDAD_CAJAS = CANTIDAD_CAJAS_PEDIDOS WHERE ITEMS = ITEMS_PEDIDOS AND CAJAS_GRANDES = CAJAS_GRANDES_PEDIDOS AND CAJAS_PEQUENAS = CAJAS_PEQUENAS_PEDIDOS;
    END LOOP;
  CLOSE CURSOR_PEDIDOS;
END;

/*Funcion 2*/
CREATE OR REPLACE FUNCTION LARGEST_SUM (array_numeros IN number_array)
RETURN INTEGER AS
  mayor_sumatoria INTEGER := 0;
  aux_mayor_sumatoria INTEGER := 0;
 BEGIN
    FOR i IN 1..array_numeros.COUNT LOOP
      aux_mayor_sumatoria := 0;
      FOR x IN i..array_numeros.COUNT LOOP
        aux_mayor_sumatoria := aux_mayor_sumatoria + array_numeros(x);
        IF (aux_mayor_sumatoria > mayor_sumatoria) THEN
          mayor_sumatoria := aux_mayor_sumatoria;
        END IF;
      END LOOP;
    END LOOP;
    
    RETURN mayor_sumatoria;
    
 END;
